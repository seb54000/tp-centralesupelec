version: '3'

# networks
networks:
  guacamole_net:
    driver: bridge

services:
  postgres:
    container_name: guacamole_database
    image: docker.io/postgres:14.9
    restart: always
    volumes:
      # - ./init:/docker-entrypoint-initdb.d:ro
      - ./data/guacamole:/var/lib/postgresql/data:rw
    environment:
      PGDATA: /var/lib/postgresql/data/guacamole
      POSTGRES_DB: guacamole_db
      POSTGRES_PASSWORD: '${GUAC_POSTGRES_PASSWORD}'
      POSTGRES_USER: '${GUAC_POSTGRES_USER}'
    networks:
      - guacamole_net

  guacd:
    container_name: guacamole_backend
    image: docker.io/guacamole/guacd:${GUACAMOLE_VERSION}
    restart: always
    networks:
      - guacamole_net
    ports:
      - "4822:4822"
    volumes:
      - ./drive:/drive:rw
      - ./record:/record:rw
    #deploy:
    #  replicas: 2

  guacamole:
    container_name: guacamole_frontend
    image: docker.io/guacamole/guacamole:${GUACAMOLE_VERSION}
    restart: always
    #ports:
    #  - "6443:8443"
    ports:
      - "80:8080"    
    hostname: ${GUAC_HOSTNAME}
    networks:
      guacamole_net:
        aliases:
          - ${GUAC_HOSTNAME}
    # volumes:
      # - ./openid/guacamole-auth-openid-${GUACAMOLE_VERSION}.jar:/opt/guacamole/openid/guacamole-auth-openid-${GUACAMOLE_VERSION}.jar:ro
      # - ./init/guacamole.crt:/usr/local/tomcat/conf/guacamole.crt:ro
      # - ./init/guacamole.key:/usr/local/tomcat/conf/guacamole.key:ro
      # - ./init/server.xml:/usr/local/tomcat/conf/server.xml:ro
      # - ./init/cacerts:/docker-java-home/jre/lib/security/cacerts:ro
      # - ./init/cacerts:/opt/java/openjdk/jre/lib/security/cacerts:ro
    environment:
      POSTGRESQL_HOSTNAME: postgres
      POSTGRESQL_DATABASE: guacamole_db
      POSTGRESQL_USER: '${GUAC_POSTGRES_USER}'
      POSTGRESQL_PASSWORD: '${GUAC_POSTGRES_PASSWORD}'
      POSTGRESQL_AUTO_CREATE_ACCOUNTS: 'true'
      GUACD_HOSTNAME: guacd
      GUACD_PORT_4822_TCP_ADDR: guacd
      GUACD_PORT_4822_TCP_PORT: 4822
      GUACAMOLE_HOSTNAME: https://guacamole:8443/#
    links:
      - guacd
    depends_on:
      - postgres
      - guacd
